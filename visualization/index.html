<!DOCTYPE html>
<meta charset="utf-8">
<style>

/*path {
  fill: #ccc;
  stroke: #fff;
  stroke-width: .5px;
}
*/

path:hover {
  fill: red;
}

.route { 
  stroke: #000;
  fill: #000;
  stroke-width: 0.8px;
 }

.counties {
  fill: none;
}

.states {
  fill: none;
  stroke: #fff;
  stroke-linejoin: round;
}


.q0-9 { fill:rgb(247,251,255); }
.q1-9 { fill:rgb(222,235,247); }
.q2-9 { fill:rgb(198,219,239); }
.q3-9 { fill:rgb(158,202,225); }
.q4-9 { fill:rgb(107,174,214); }
.q5-9 { fill:rgb(66,146,198); }
.q6-9 { fill:rgb(33,113,181); }
.q7-9 { fill:rgb(8,81,156); }
.q8-9 { fill:rgb(8,48,107); }


  div.d3-tip {
    position: absolute;     
    text-align: center;     
    width: 50px;          
    height: 17px;         
    padding: 2px;       
    font: 12px sans-serif;    
    background: #000; 
    border: 1px;    
    border-radius: 8px;     
    pointer-events: none; 
    color: white;   
 
}


</style>
<body>
<div id="airportSelect"></div>
<script type="text/javascript" src="../lib/d3/d3.v3.min.js"></script>
<script type="text/javascript" src="../lib/topojson.v1.min.js"></script>
<script type="text/javascript" src="../lib/d3-queue.min.js"></script>
<script type="text/javascript" src="../lib/d3-tip.js"></script>

<script>

var width = 960,
    height = 500;

var rateById = d3.map();

var projection = d3.geo.albers(); //albersUsa projection will show HI and AL but the routes look strange
var path = d3.geo.path().projection(projection);


var quantize = d3.scale.quantize()
    .domain([0, .15])
    .range(d3.range(9).map(function(i) { return "q" + i + "-9"; }));


var svg = d3.select("body").append("svg")
    .attr("width", width)
    .attr("height", height);


//this bit loads in all possible airports in the US 
d3.json("mapFiles/airports.json", function(error, data) {
  if (error) throw error;

  var filterIATA = ["ATL", "JFK", "ORD", "SFO", "LAX", "SLC", "MSP", "DTW", "HOU", "SEA", "HNL", "ANC", "DAL", "LGA", "MIA"]

  //checks to see if part of the analyzed airports and creates citiesData array from the filtered results
  citiesData = {"data" : []};
  data.forEach(function(d) {
    if (filterIATA.indexOf(d.iata) > -1) {
      citiesData.data.push({"iata": d.iata,
                            "lon": +d.lon,
                            "lat": +d.lat});
    }
  }); 



  var myDiv = document.getElementById("airportSelect");

  //Create and append select list
  var selectList = document.createElement("select");
  selectList.id = "mySelect";
  myDiv.appendChild(selectList);

  //Create and append the options
  var firstOption = document.createElement("option"); 
  firstOption.value = "";
  firstOption.text = "Airport"; 
  selectList.appendChild(firstOption);

  citiesData.data.forEach(function(d) {
      var option = document.createElement("option");
      option.value = d.iata;
      option.text = d.iata;
      selectList.appendChild(option);
  });

  var e = document.getElementById("mySelect");
  var strUser = e.options[e.selectedIndex].value;




//object that contains the airport as the keys in the nested array
  airportData = {}
  data.forEach(function(d) {
      if (filterIATA.indexOf(d.iata) > -1) {
        var airport = d.iata
        airportData[airport] = {"lon" : +d.lon,  "lat" : +d.lat};
      }
    }); 


 d3_queue.queue()
    .defer(d3.json, "mapFiles/us.json")
    .defer(d3.tsv, "mapFiles/unemployment.tsv", function(d) { rateById.set(d.id, +d.rate); })
    .await(ready);


//d3.json("mapFiles/us.json", function(error, topology) {

function ready(error, topology) {  
  if (error) throw error;

    projection
    .scale(1000);



  svg.append("g")
      .attr("class", "counties")
    .selectAll("path")
      .data(topojson.feature(topology, topology.objects.counties).features)
    .enter().append("path")
     .attr("class", function(d) { return quantize(rateById.get(d.id)); })
      .attr("d", path);

  svg.append("path")
      .datum(topojson.mesh(topology, topology.objects.states, function(a, b) { return a !== b; }))
      .attr("class", "states")
      .attr("d", path);


//plot the airport coordinates as circles
 svg.selectAll(".pin")
  .data(citiesData.data)
  .enter().append("circle", ".pin")
  .attr("r", 3)
  .style("stroke", "white")
  .attr("transform", function(d) {
    return "translate(" + projection([
      d.lon,
      d.lat
    ]) + ")"})

//Plot transparent circles in the same locations to have larger tooltip range
 svg.selectAll(".pin")
  .data(citiesData.data)
  .enter().append("circle", ".pin")
  .attr("fill-opacity", "0")
  .attr("r", 10) 
  .attr("transform", function(d) {
    return "translate(" + projection([
      d.lon,
      d.lat
    ]) + ")"})
  .on("mouseover", function(d) {    
      div.transition()    
      .duration(200)    
      .style("opacity", .9);    
      div.html(d.iata)  
      .style("left", (d3.event.pageX) + "px")   
      .style("top", (d3.event.pageY - 28) + "px");  
    })          
      .on("mouseout", function(d) {   
        div.transition()    
        .duration(500)    
        .style("opacity", 0); 
      });

  
var div = d3.select("body").append("div") 
    .attr("class", "d3-tip")       
    .style("opacity", 0);



    var g = svg.append("g");
    var arcGroup = g.append('g');
    //var selection = "MSP";

//transition code used from http://bl.ocks.org/enoex/6201948
  var lineTransition = function lineTransition(path) {
      path.transition()
          //NOTE: Change this number (in ms) to make lines draw faster or slower
          .duration(2000)
          .attrTween("stroke-dasharray", tweenDash)
          .each("end", function(d,i) { 
          });
  };

  var tweenDash = function tweenDash() {
      //This function is used to animate the dash-array property, which is a
      //  nice hack that gives us animation along some arbitrary path (in this
      //  case, makes it look like a line is being drawn from point A to B)
      var len = this.getTotalLength(),
          interpolate = d3.interpolateString("0," + len, len + "," + len);

      return function(t) { return interpolate(t); };
  };

function updateRoutes(selection) {

   links = [];

    citiesData.data.forEach(function(d) {
        links.push({
          type : "LineString",
          coordinates: [
            [airportData[selection].lon, airportData[selection].lat],
            [d.lon, d.lat]
          ]
        });
    }); 

    // Standard enter / update 
    var pathArcs = arcGroup.selectAll(".arc")
        .data(links);
    //enter
    pathArcs.enter()
        .append("path").attr({
            'class': 'arc'
        }).style({ 
            fill: 'none',
        });

    //update
    pathArcs.attr({
            //d is the points attribute for this path, we'll draw
            //  an arc between the points using the arc function
            d: path
        })
        .style({
            stroke: '#000',
            'stroke-width': '0.8px'
        })
        .call(lineTransition); 


    //exit
    pathArcs.exit().remove();
} 

function clearRoutes() {
    svg.selectAll('arc').remove();
}


d3.select(e)
  .on('change', function() {
    var selection = d3.select(this).property('value');
    clearRoutes();
    updateRoutes(selection);
});



};
});

</script>
